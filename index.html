<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Ritual Combat – Locked Prototype</title>

<style>
  body {
    background:#0e0e0e;
    color:#eaeaea;
    font-family:system-ui, sans-serif;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    height:100vh;
    gap:18px;
  }

  h3 { margin-bottom:6px; }

  .row {
    display:flex;
    align-items:center;
    gap:24px;
  }

  .bar-container {
    width:320px;
    height:18px;
    background:#2a2a2a;
    border-radius:9px;
    overflow:hidden;
  }

  .bar-fill {
    height:100%;
    width:100%;
    background:#c0392b;
    transition:width 0.25s ease;
  }

  .paw-container {
    width:28px;
    height:120px;
    border:2px solid #aaa;
    border-radius:14px;
    background:#111;
    overflow:hidden;
    position:relative;
    opacity:0.4;
  }

  .paw-fill {
    position:absolute;
    bottom:0;
    width:100%;
    height:0%;
    background:linear-gradient(to top,#2ecc71,#a8f5c2);
    transition:height 0.12s ease;
  }

  .buttons {
    display:flex;
    gap:12px;
  }

  button {
    padding:10px 16px;
    border-radius:6px;
    border:none;
    font-size:14px;
    cursor:pointer;
    background:#f0f0f0;
    color:#111;
  }

  button:disabled {
    opacity:0.35;
    cursor:not-allowed;
  }

  .log {
    width:420px;
    min-height:52px;
    text-align:center;
    opacity:0.9;
    font-size:14px;
  }
</style>
</head>

<body>

<h3>Animal State</h3>

<div class="row">
  <div class="bar-container">
    <div id="resistanceBar" class="bar-fill"></div>
  </div>

  <div class="paw-container" id="pawContainer">
    <div id="pawFill" class="paw-fill"></div>
  </div>
</div>

<div class="buttons">
  <button id="attackBtn">Defend / Strike</button>
  <button id="puffBtn">Throw Puff Ball</button>
  <button id="herbBtn">Apply Herb</button>
</div>

<div id="log" class="log"></div>

<script>
/* ================== STATE ================== */
let state = "aggressive";        // aggressive | dizzy | ritual | purified
let resistance = 100;
let ritualProgress = 0;
let dizzyTimer = null;
let ritualDecay = null;
let attackFatigue = 0;
let dizzyType = null;            // "puff" | "strike"

/* ================== ELEMENTS ================== */
const bar = document.getElementById("resistanceBar");
const paw = document.getElementById("pawFill");
const pawContainer = document.getElementById("pawContainer");
const log = document.getElementById("log");

const attackBtn = document.getElementById("attackBtn");
const puffBtn = document.getElementById("puffBtn");
const herbBtn = document.getElementById("herbBtn");

/* ================== HELPERS ================== */
function write(text) {
  log.innerText = text;
}

function updateBar() {
  bar.style.width = resistance + "%";
}

function updateButtons() {
  attackBtn.disabled = state !== "aggressive";
  puffBtn.disabled   = state !== "aggressive";
  herbBtn.disabled   = state !== "dizzy";
}

function resetRitual() {
  clearInterval(ritualDecay);
  ritualProgress = 0;
  paw.style.height = "0%";
  pawContainer.style.opacity = 0.4;
}

/* ================== PASSIVE ================== */
setInterval(() => {
  if (state !== "aggressive") return;
  resistance = Math.min(100, resistance + 4);
  updateBar();
}, 2500);

/* ================== ACTIONS ================== */

// DEFENSIVE STRIKE
attackBtn.onclick = () => {
  if (state !== "aggressive") return;

  const effectiveness = Math.max(6 - attackFatigue, 2);
  resistance = Math.max(20, resistance - effectiveness);

  attackFatigue++;
  setTimeout(() => attackFatigue = Math.max(0, attackFatigue - 1), 2000);

  write("You strike defensively, creating space.");
  updateBar();

  // ACCIDENTAL STRIKE DIZZY (RARE)
  if (resistance <= 70 && Math.random() < 0.25) {
    state = "dizzy";
    dizzyType = "strike";
    updateButtons();
    write("The animal stumbles briefly.");

    dizzyTimer = setTimeout(() => {
      if (state === "dizzy" && dizzyType === "strike") {
        state = "aggressive";
        dizzyType = null;
        write("The animal regains its footing.");
        updateButtons();
      }
    }, 1500);
  }
};

// PUFF BALL
puffBtn.onclick = () => {
  if (state !== "aggressive") return;

  const successChance =
    resistance <= 35 ? 0.95 :
    resistance <= 60 ? 0.7  :
    0.45;

  write("You throw a puff ball…");

  setTimeout(() => {
    if (Math.random() < successChance) {
      state = "dizzy";
      dizzyType = "puff";
      updateButtons();
      write("The animal reels — a clear opening appears.");

      dizzyTimer = setTimeout(() => {
        if (state === "dizzy" && dizzyType === "puff") {
          state = "aggressive";
          dizzyType = null;
          write("The animal regains control.");
          updateButtons();
        }
      }, 4200);
    } else {
      write("The disruption fails. The animal resists.");
    }
  }, 700);
};

// APPLY HERB
herbBtn.onclick = () => {
  if (state === "dizzy" && dizzyType === "strike") {
    write("The opening is too unstable. This is too risky.");
    return;
  }

  if (state !== "dizzy") return;

  clearTimeout(dizzyTimer);
  state = "ritual";
  updateButtons();

  ritualProgress = 0;
  pawContainer.style.opacity = 1;
  paw.style.height = "0%";

  write("You begin the purification ritual. Stay focused.");

  ritualDecay = setInterval(() => {
    ritualProgress = Math.max(0, ritualProgress - 5);
    paw.style.height = ritualProgress + "%";

    if (ritualProgress === 0) {
      failRitual();
    }
  }, 300);
};

// RITUAL INPUT
document.body.addEventListener("click", () => {
  if (state !== "ritual") return;

  ritualProgress = Math.min(100, ritualProgress + 9);
  paw.style.height = ritualProgress + "%";

  if (ritualProgress >= 100) {
    succeedRitual();
  }
});

/* ================== RESOLUTION ================== */
function failRitual() {
  clearInterval(ritualDecay);
  resetRitual();
  state = "aggressive";
  dizzyType = null;
  resistance = Math.min(100, resistance + 15);
  write("The ritual breaks. The animal surges back.");
  updateBar();
  updateButtons();
}

function succeedRitual() {
  clearInterval(ritualDecay);
  state = "purified";
  dizzyType = null;
  paw.style.height = "100%";
  bar.style.background = "#2ecc71";
  write("Balance is restored. The animal retreats.");
  updateButtons();
}

/* ================== INIT ================== */
write("An imbalanced animal blocks your path.");
updateBar();
updateButtons();
</script>

</body>
</html>
